name: Test Completions Generation
on:
  workflow_dispatch:
  push:
    branches:
      - add-shell-completions

jobs:
  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable

      - name: Build binary
        run: cargo build --release --features vendored-openssl

      - name: Test completion generation
        run: |
          BIN="target/release/lychee"
          chmod +x $BIN

          # Test all completion types
          echo "Testing Bash completion..."
          $BIN --generate complete-bash > /tmp/lychee.bash

          echo "Testing Elvish completion..."
          $BIN --generate complete-elvish > /tmp/lychee.elv

          echo "Testing Fish completion..."
          $BIN --generate complete-fish > /tmp/lychee.fish

          echo "Testing PowerShell completion..."
          $BIN --generate complete-powershell > /tmp/_lychee.ps1

          echo "Testing Zsh completion..."
          $BIN --generate complete-zsh > /tmp/_lychee

          # Verify files were created and are not empty
          for file in /tmp/lychee.bash /tmp/lychee.elv /tmp/lychee.fish /tmp/_lychee.ps1 /tmp/_lychee; do
            if [ ! -s "$file" ]; then
              echo "Error: $file is empty or missing"
              exit 1
            fi
            echo "✓ $(basename $file): $(wc -l < $file) lines"
          done

          echo "✅ All completions generated successfully!"

  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable

      - name: Build and test completions
        run: |
          cargo build --release
          BIN="target/release/lychee"

          # Quick test
          $BIN --generate complete-bash > /tmp/test.bash
          $BIN --generate complete-fish > /tmp/test.fish
          $BIN --generate complete-zsh > /tmp/test.zsh

          echo "✅ macOS completions work!"
